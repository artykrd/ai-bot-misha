Обзор
API (Application Programming Interface) — это посредник между разработчиком приложений и средой, с которой это приложение должно взаимодействовать. API упрощает написание кода за счёт набора готовых классов, функций или структур для работы с данными

API MAX — это интерфейс, который позволяет ботам взаимодействовать с платформой и получать необходимые данные с помощью HTTPS-запросов к серверу. В этом разделе расскажем, как подготовиться к использованию API приложения

Методы
HTTPS-запросы на домен platform-api.max.ru вызывают методы — условные команды, которые соответствуют той или иной операции с базой данных. Например, получение, запись или удаление какой-либо информации
Параметры запроса должны содержать HTTP-метод, соответствующий необходимой операции:

GET — получить ресурсы
POST — создать ресурсы (например, отправить новые сообщения)
PUT — редактировать ресурсы
DELETE — удалить ресурсы
PATCH — исправить ресурсы
В зависимости от конкретного метода, параметры запроса будут отображаться в пути, URL-параметрах или теле запроса

Передача токена через query-параметры больше не поддерживается — используйте заголовок Authorization: <token>

Примеры запросов:

GET https://platform-api.max.ru/messages/{messageId} — получить сообщения
POST https://platform-api.max.ru/messages — отправить сообщения
PATCH https://platform-api.max.ru/chats/{chatId} — изменить информацию о чате
В ответ сервер вернёт JSON-объект с запрошенными данными или сообщение об ошибке, если что-то пойдёт не так
JSON — это формат записи данных в виде пар <ИМЯ_СВОЙСТВА>: <ЗНАЧЕНИЕ>. Прочитайте об особенностях формата JSON, если вы ещё не работали с ним
Пример ответа на запрос к методу GET /me:

JSON
{
	"user_id": 1,
	"name": "My Bot",
	"username": "my_bot",
	"is_bot": true,
	"last_activity_time": 1737500130100
}
Также, помимо JSON, сервер вернет трёхзначный HTTP-код, информирующий об успешном выполнении запроса или ошибке.

Коды ответов HTTP
200 — успешная операция
400 — недействительный запрос
401 — ошибка аутентификации
404 — ресурс не найден
405 — метод не допускается
429 — превышено количество запросов
503 — сервис недоступен
Рекомендации по работе с API
Когда вы настраиваете получение обновлений о действиях в чат-боте, используйте:

Long Polling — для разработки и тестирования
только Webhook — для production-окружения
Для стабильной работы ботов убедитесь, что максимальное количество запросов в секунду на platform-api.max.ru — 30 rps

Клавиатура
Клавиатура позволяет отправлять боту запросы кнопками, а не сообщениями. Чтобы клавиатура была удобной для пользователей, рекомендуем заранее продумать её наполнение и учитывать обязательные параметры:

Текст на кнопке выравнивается по центру и обрезается, если выходит за её границы
Кнопки в одной строке всегда одинаковой ширины
Ширина каждого ряда кнопок равна ширине клавиатуры
Высота у всех кнопок по умолчанию одинаковая
Вы можете подключить к чат-боту в MAX inline-клавиатуру. Она позволяет разместить под сообщением бота до 210 кнопок, сгруппированных в 30 рядов — до 7 кнопок в каждом (до 3, если это кнопки типа link, open_app, request_geo_location или request_contact)

Для кнопки с видом link максимальный размер ссылки составляет 2048 символов

Виды кнопок для чат-бота:

callback — сервер MAX отправляет событие с типом message_callback (через Webhook или Long polling)
Обратите внимание: для отправки вебхуков поддерживается только протокол HTTPS, включая самоподписанные сертификаты. HTTP не поддерживается

link — позволяет открыть ссылку в новой вкладке
request_contact — запрашивает у пользователя его контакт и номер телефона
request_geo_location — запрашивает у пользователя его местоположение
open_app — открывает мини-приложение
message — отправляет боту текстовое сообщение
Чтобы добавить кнопки, отправьте сообщение с InlineKeyboardAttachment

JSON
{
  "text": "It is message with inline keyboard",
  "attachments": [
    {
      "type": "inline_keyboard",
      "payload": {
        "buttons": [
          [
            {
              "type": "callback",
              "text": "Press me!",
              "payload": "button1 pressed"
            }
          ]
        ]
      }
    }
  ]
}
Форматирование текста
Текст сообщения в чат-боте можно улучшить с помощью базового форматирования. Для этого вы можете использовать либо Markdown, либо HTML

Markdown
Чтобы включить разбор Markdown, установите свойство format в NewMessageBody на значение markdown

Markdown	Отображение
курсив	*empasized* или _empasized_
жирный	**strong** или __strong__
зачёркнутый	~~strikethough~~
подчёркнутый	++underline++
моноширинный	`code` (переводы строк внутри этого блока обрабатываются как пробелы)
ссылка	[Inline URL](https://dev.max.ru/)
@упоминание пользователя	"text": "[Имя Фамилия](max://user/user_id)", "format": "markdown"
Вместо User mention указывайте полное имя пользователя из профиля в MAX, в том числе фамилию. Если фамилия отсутствует — только имя
HTML
Чтобы включить разбор HTML, установите свойство format в NewMessageBody на значение html

Markdown	Отображение
курсив	<i> или <em>
жирный	<b> или <strong>
зачёркнутый	<del> или <s>
подчёркнутый	<ins> или <u>
моноширинный	<pre> или <code>
ссылка	<a href="https://dev.max.ru">Docs</a>
@упоминание пользователя	"text": "<a href=\"max://user/user_id\">Имя Фамилия</a>", "format": "html"
Вместо User mention указывайте полное имя пользователя из профиля в MAX, в том числе фамилию. Если фамилия отсутствует — только имя

Получение информации о боте
GET
/me

Метод возвращает информацию о боте, который идентифицируется с помощью токена доступа access_token. В ответе приходит объект User с вариантом наследования BotInfo, который содержит идентификатор бота, его название, никнейм, время последней активности, описание и аватар (при наличии)

Пример запроса:

BASH
curl -X GET "https://platform-api.max.ru/me" \
  -H "Authorization: {access_token}"
Авторизация
access_token
apiKey
Передача токена через query-параметры больше не поддерживается — используйте заголовок Authorization: <token>

Токен для вызова HTTP-запросов присваивается при создании бота — его можно найти в разделе платформы MAX для партнёров Интеграция → Получить токен

Рекомендуем не разглашать токен посторонним, чтобы они не получили доступ к управлению ботом. Токен может быть отозван за нарушение Правил платформы

Результат
user_id
integer <int64>
Идентификатор пользователя или бота

first_name
string
Отображаемое имя пользователя или бота

last_name
string Nullable optional
Отображаемая фамилия пользователя. Для ботов это поле не возвращается

username
string Nullable
Никнейм бота или уникальное публичное имя пользователя. В случае с пользователем может быть null, если тот недоступен или имя не задано

is_bot
boolean
true, если это бот

last_activity_time
integer <int64>
Время последней активности пользователя или бота в MAX (Unix-время в миллисекундах). Если пользователь отключил в настройках профиля мессенджера MAX возможность видеть, что он в сети онлайн, поле может не возвращаться

name
string Nullable
Устаревшее поле, скоро будет удалено

description
string Nullable optional
до 16000 символов

Описание пользователя или бота. В случае с пользователем может принимать значение null, если описание не заполнено

avatar_url
string optional
URL аватара пользователя или бота в уменьшенном размере

full_avatar_url
string optional
URL аватара пользователя или бота в полном размере

commands
BotCommand[] Nullable optional
до 32 элементов

Команды, поддерживаемые ботом


Получение списка всех групповых чатов
GET
/chats

Возвращает список групповых чатов, в которых участвовал бот, информацию о каждом чате и маркер для перехода к следующей странице списка

Пример запроса:

BASH
curl -X GET "https://platform-api.max.ru/chats" \
  -H "Authorization: {access_token}"
Авторизация
access_token
apiKey
Передача токена через query-параметры больше не поддерживается — используйте заголовок Authorization: <token>

Токен для вызова HTTP-запросов присваивается при создании бота — его можно найти в разделе платформы MAX для партнёров Интеграция → Получить токен

Рекомендуем не разглашать токен посторонним, чтобы они не получили доступ к управлению ботом. Токен может быть отозван за нарушение Правил платформы

Параметры
count
integer [1-100] optional
По умолчанию: 50

Количество запрашиваемых чатов

marker
integer bigint <int64> optional
Указатель на следующую страницу данных. Для первой страницы передайте null

Результат
chats
Chat[]
Список запрашиваемых чатов

marker
integer <int64> Nullable
Указатель на следующую страницу запрашиваемых чатов


Загрузка файлов
POST
/uploads

Возвращает URL для последующей загрузки файла

Параметр type=photo больше не поддерживается. Если вы использовали type=photo в ранее созданных интеграциях — замените его на type=image

Поддерживаются два типа загрузки:

Multipart upload — более простой, но менее надёжный способ. В этом случае используется заголовок Content-Type: multipart/form-data. Этот способ имеет ограничения:

Максимальный размер файла: 4 ГБ
Можно загружать только один файл за раз
Невозможно перезапустить загрузку, если она была остановлена
Resumable upload — более надёжный способ, если заголовок Content-Type не равен multipart/form-data. Этот способ позволяет загружать файл частями и возобновить загрузку с последней успешно загруженной части в случае ошибок

Пример получения ссылки для загрузки:

BASH
curl -X POST "https://platform-api.max.ru/uploads?type=file" \
  -H "Authorization: {access_token}"
Пример загрузки файла по полученному URL:

BASH
curl -X POST "%UPLOAD_URL%" \
  -H "Authorization: {access_token}" \
  -F "data=@example.mp4"
Пример использования cURL для загрузки файла (вариант multipart upload):

SHELL
curl -i -X POST \
  -H "Content-Type: multipart/form-data" \
  -F "data=@movie.pdf" "%UPLOAD_URL%"
Где %UPLOAD_URL% — это URL из результата метода в примере cURL запроса

Для загрузки видео и аудио:

Когда получаем ссылку на загрузку видео или аудио (POST /uploads с type = video или type = audio), вместе с url в ответе приходит token, который нужно использовать в сообщении (когда формируете body с attachments) в POST /messages.

После загрузки видео или аудио (по url из шага выше) сервер возвращает retval

C этого момента можно использовать token, чтобы прикреплять вложение в сообщение бота

Механика отличается от type = image | file, где token возвращается в ответе на загрузку изображения или файла

Прикрепление медиа
Медиафайлы прикрепляются к сообщениям поэтапно:

Получите URL для загрузки медиафайлов
Загрузите файл по полученному URL
После успешной загрузки получите JSON-объект в ответе. Используйте этот объект для создания вложения. Структура вложения:
type: тип медиа (например, "video")
payload: JSON-объект, который вы получили
Пример для видео:

Получите URL для загрузки:
BASH
curl -X POST "https://platform-api.max.ru/uploads?type=video" \
  -H "Authorization: {access_token}"
Ответ:

JSON
{
    "url": "https://vu.mycdn.me/upload.do…"
}
Загрузите видео по URL:
BASH
curl -X POST \
  -H "Content-Type: multipart/form-data" \
  -F "data=@movie.mp4" \
  "https://vu.mycdn.me/upload.do?sig={signature}&expires={timestamp}"
Ответ:

JSON
{
    "token": "_3Rarhcf1PtlMXy8jpgie8Ai_KARnVFYNQTtmIRWNh4"
}
Отправьте сообщение с вложением:
JSON
{
    "text": "Message with video",
    "attachments": [
        {
            "type": "video",
            "payload": {
                "token": "_3Rarhcf1PtlMXy8jpgie8Ai_KARnVFYNQTtmIRWNh4"
            }
        }
    ]
}
Обработка файлов
После успешной загрузки сервер обрабатывает файл. Файлы от нескольких мегабайт обрабатываются дольше

Если отправить сообщение с вложением сразу после загрузки, может возникнуть ошибка:

JSON
{
  "code": "attachment.not.ready",
  "message": "Key: errors.process.attachment.file.not.processed"
}
Как избежать ошибки:

После загрузки файла сделайте паузу перед отправкой сообщения
Если отправка не удалась, повторите попытку через некоторое время. Увеличивайте интервал с каждой попыткой
Загружайте часто используемые файлы заранее и переиспользуйте токен
Авторизация
access_token
apiKey
Передача токена через query-параметры больше не поддерживается — используйте заголовок Authorization: <token>

Токен для вызова HTTP-запросов присваивается при создании бота — его можно найти в разделе платформы MAX для партнёров Интеграция → Получить токен

Рекомендуем не разглашать токен посторонним, чтобы они не получили доступ к управлению ботом. Токен может быть отозван за нарушение Правил платформы

Параметры
type
enum UploadType
Enum: "image" "video" "audio" "file"

Тип загружаемого файла

Поддерживаемые форматы:

image: JPG, JPEG, PNG, GIF, TIFF, BMP, HEIC
video: MP4, MOV, MKV, WEBM, MATROSKA
audio: MP3, WAV, M4A и другие
file: любые типы файлов
Значение photo больше не поддерживается. Если вы использовали type=photo в ранее созданных интеграциях — замените его на type=image

Результат
url
string
URL для загрузки файла

token
string optional
Видео- или аудио-токен для отправки сообщения

Message
Сообщение в чате

sender
object User optional
Пользователь, отправивший сообщение

recipient
object Recipient
Получатель сообщения. Может быть пользователем или чатом

timestamp
integer <int64>
Время создания сообщения в формате Unix-time

link
object LinkedMessage Nullable optional
Пересланное или ответное сообщение

body
object MessageBody
Содержимое сообщения. Текст + вложения. Может быть null, если сообщение содержит только пересланное сообщение

stat
object MessageStat Nullable optional
Статистика сообщения.

url
string Nullable optional
Публичная ссылка на пост в канале. Отсутствует для диалогов и групповых чатов

Пример объекта
JSON
{
    "sender": { ... },
    "recipient": { ... },
    "timestamp": 0,
    "link": { ... },
    "body": { ... },
    "stat": { ... },
    "url": "string"
}


Update
ОбъектUpdate представляет различные типы событий, произошедших в чате. См. его наследников

Чтобы получать события из группового чата или канала, назначьте бота администратором

update_type
string
timestamp
integer <int64>
Unix-время, когда произошло событие

message
object Message
Новое созданное сообщение

user_locale
string Nullable optional
Текущий язык пользователя в формате IETF BCP 47. Доступно только в диалогах

Пример объекта
JSON
{
    "update_type": "message_created"
message_created
,
    "timestamp": 0,
    "message": { ... },
    "user_locale": "string"
}