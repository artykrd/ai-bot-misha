# Техническое задание: Telegram-бот для доступа к нейросетям

**Версия:** 1.0  
**Дата:** 2025-11-08  
**Тип проекта:** Telegram-бот с подписочной моделью

---

## 1. Общее описание проекта

### 1.1 Цель проекта
Разработать Telegram-бота, предоставляющего пользователям доступ к различным AI-моделям через подписочную токеновую систему. Бот должен обеспечивать генерацию контента (изображения, видео, текст, аудио) и обработку файлов.

### 1.2 Основной функционал
- **Генерация изображений:** Nano Banana, GPT Image, Midjourney, Recraft, DALL-E 3, Stable Diffusion, замена лиц
- **Генерация видео:** Sora 2, Veo 3.1, Midjourney Video, Hailuo, Luma, Kling, Kling Effects
- **Работа с фотографиями:** улучшение качества, удаление/замена фона, векторизация
- **Языковые модели:** ChatGPT, DeepSeek, Sonar, Gemini, Claude и другие
- **Аудио инструменты:** создание музыки (Suno), распознавание речи (Whisper), синтез речи (TTS)
- **Диалоги:** сохранение истории общения с AI-моделями
- **Подписочная система:** токеновая модель с различными тарифами
- **Реферальная программа:** начисление бонусов за приглашения

### 1.3 Целевая аудитория
- Дизайнеры и креаторы
- Контент-мейкеры
- Разработчики и предприниматели
- Обычные пользователи, интересующиеся AI

---

## 2. Технический стек

### 2.1 Основные технологии
- **Язык разработки:** Python 3.11+
- **Фреймворк бота:** aiogram 3.x
- **База данных:** PostgreSQL 15+
- **Кеширование:** Redis
- **Платежная система:** ЮKassa API
- **Веб-сервер:** FastAPI (для webhook'ов)
- **Контейнеризация:** Docker + Docker Compose

### 2.2 Дополнительные инструменты
- **Мониторинг:** Prometheus + Grafana
- **Логирование:** Структурированные JSON логи
- **Обработка изображений:** Pillow, OpenCV
- **Обработка видео:** FFmpeg
- **Планировщик задач:** APScheduler
- **Валидация данных:** Pydantic
- **Миграции БД:** Alembic
- **Тестирование:** pytest

---

## 3. Архитектура системы

### 3.1 Компоненты системы

#### 3.1.1 Основной бот (Main Bot)
- Обработка пользовательских команд и сообщений
- Интеграция с AI-сервисами
- Управление файлами и медиа
- Обработка платежей
- Система диалогов

#### 3.1.2 Админ-бот (Admin Bot)
- Управление пользователями (бан/разбан)
- Статистика и аналитика
- Управление платежами и возвратами
- Реферальная программа
- Создание промокодов
- Мониторинг системы

#### 3.1.3 AI Services Layer
- Унифицированный интерфейс для всех AI-сервисов
- Система кеширования результатов
- Rate limiting и управление ключами API
- Обработка ошибок и retry механизмы

#### 3.1.4 Payment Service
- Интеграция с ЮKassa
- Обработка webhook'ов платежей
- Управление подписками
- Система возвратов

#### 3.1.5 File Storage Service
- Локальное хранение файлов
- Автоматическое сжатие без потери качества
- Очистка старых файлов (3 дня)
- Управление правами доступа

### 3.2 Взаимодействие компонентов
- Все компоненты взаимодействуют через базу данных PostgreSQL
- Redis используется для кеширования и сессий
- Файлы хранятся локально с доступом через веб-интерфейс
- Мониторинг осуществляется через Prometheus метрики

---

## 4. База данных

### 4.1 Основные таблицы

#### 4.1.1 users - Пользователи
**Назначение:** Хранение информации о пользователях бота
**Поля:**
- id (BIGSERIAL) - Внутренний ID
- telegram_id (BIGINT) - ID в Telegram
- username (VARCHAR) - Имя пользователя
- first_name, last_name (VARCHAR) - Имя и фамилия
- language_code (VARCHAR) - Код языка
- is_banned (BOOLEAN) - Статус блокировки
- ban_reason (TEXT) - Причина блокировки
- created_at, updated_at - Временные метки
- last_activity - Последняя активность

#### 4.1.2 subscriptions - Подписки
**Назначение:** Управление подписками пользователей
**Поля:**
- id (BIGSERIAL) - ID подписки
- user_id (BIGINT) - Ссылка на пользователя
- subscription_type (VARCHAR) - Тип подписки (7days, 14days, и т.д.)
- tokens_amount (BIGINT) - Количество токенов
- tokens_used (BIGINT) - Использованные токены
- price (DECIMAL) - Стоимость
- is_active (BOOLEAN) - Активна ли подписка
- started_at, expires_at - Время начала и окончания
- created_at - Дата создания

#### 4.1.3 ai_requests - AI запросы
**Назначение:** Логирование всех запросов к AI-сервисам
**Поля:**
- id (BIGSERIAL) - ID запроса
- user_id (BIGINT) - Пользователь
- request_type (VARCHAR) - Тип запроса (text, image, video, audio)
- ai_model (VARCHAR) - Используемая модель
- prompt (TEXT) - Текст запроса
- tokens_cost (BIGINT) - Стоимость в токенах
- status (VARCHAR) - Статус (pending, completed, failed)
- response_file_path (TEXT) - Путь к результату
- error_message (TEXT) - Текст ошибки
- processing_time_seconds (INTEGER) - Время обработки
- created_at, updated_at - Временные метки

#### 4.1.4 payments - Платежи
**Назначение:** Учет всех платежных операций
**Поля:**
- id (BIGSERIAL) - ID платежа
- user_id (BIGINT) - Пользователь
- subscription_id (BIGINT) - Связанная подписка
- payment_id (VARCHAR) - Уникальный ID платежа
- amount (DECIMAL) - Сумма
- currency (VARCHAR) - Валюта
- status (VARCHAR) - Статус (pending, success, failed, refunded)
- payment_method (VARCHAR) - Способ оплаты
- yukassa_payment_id (VARCHAR) - ID в ЮKassa
- yukassa_response (JSONB) - Ответ от ЮKassa
- created_at, updated_at - Временные метки

#### 4.1.5 dialogs - Диалоги с AI
**Назначение:** Управление диалогами пользователей
**Поля:**
- id (BIGSERIAL) - ID диалога
- user_id (BIGINT) - Пользователь
- title (VARCHAR) - Название диалога
- ai_model (VARCHAR) - Модель AI
- system_prompt (TEXT) - Системный промпт
- is_history_enabled (BOOLEAN) - Включена ли история
- created_at, updated_at - Временные метки

#### 4.1.6 dialog_messages - Сообщения диалогов
**Назначение:** Хранение истории сообщений в диалогах
**Поля:**
- id (BIGSERIAL) - ID сообщения
- dialog_id (BIGINT) - Диалог
- role (VARCHAR) - Роль (user, assistant, system)
- content (TEXT) - Содержимое сообщения
- tokens_used (BIGINT) - Потрачено токенов
- created_at - Время создания

#### 4.1.7 referrals - Реферальная система
**Назначение:** Управление реферальными отношениями
**Поля:**
- id (BIGSERIAL) - ID записи
- referrer_id (BIGINT) - ID реферера
- referred_id (BIGINT) - ID реферала
- referral_code (VARCHAR) - Реферальный код
- tokens_earned (BIGINT) - Заработанные токены
- money_earned (DECIMAL) - Заработанные деньги
- is_active (BOOLEAN) - Активна ли связь
- created_at - Дата создания

#### 4.1.8 files - Файлы
**Назначение:** Управление загруженными и созданными файлами
**Поля:**
- id (BIGSERIAL) - ID файла
- user_id (BIGINT) - Пользователь
- ai_request_id (BIGINT) - Связанный AI запрос
- file_type (VARCHAR) - Тип файла (image, video, audio)
- file_path (TEXT) - Путь к файлу
- file_size (BIGINT) - Размер файла
- mime_type (VARCHAR) - MIME тип
- is_compressed (BOOLEAN) - Сжат ли файл
- original_file_path (TEXT) - Путь к оригиналу
- expires_at - Время удаления файла
- created_at - Дата создания

#### 4.1.9 ai_models - Модели AI
**Назначение:** Конфигурация доступных AI моделей
**Поля:**
- id (BIGSERIAL) - ID модели
- name (VARCHAR) - Системное имя
- display_name (VARCHAR) - Отображаемое имя
- model_type (VARCHAR) - Тип (text, image, video, audio)
- provider (VARCHAR) - Провайдер (openai, anthropic, и т.д.)
- api_endpoint (TEXT) - Endpoint API
- tokens_per_request (BIGINT) - Стоимость в токенах
- is_active (BOOLEAN) - Активна ли модель
- rate_limit_per_minute (INTEGER) - Лимит запросов в минуту
- settings (JSONB) - Настройки модели
- created_at, updated_at - Временные метки

#### 4.1.10 ai_cache - Кеш AI результатов
**Назначение:** Кеширование результатов AI для экономии ресурсов
**Поля:**
- id (BIGSERIAL) - ID записи
- request_hash (VARCHAR) - Хеш запроса (SHA256)
- model_name (VARCHAR) - Модель
- prompt_hash (VARCHAR) - Хеш промпта
- response_data (JSONB) - Кешированный ответ
- file_path (TEXT) - Путь к файлу
- access_count (INTEGER) - Количество использований
- created_at - Дата создания
- expires_at - Время истечения кеша

### 4.2 Дополнительные таблицы

#### 4.2.1 promocodes - Промокоды
- Управление промокодами и скидками

#### 4.2.2 promocode_uses - Использование промокодов
- Отслеживание активаций промокодов

#### 4.2.3 system_settings - Системные настройки
- Конфигурируемые параметры системы

#### 4.2.4 admin_logs - Логи администрирования
- Журнал действий администраторов

### 4.3 Индексы и оптимизация
- Индексы на telegram_id для быстрого поиска пользователей
- Индексы на временные поля для аналитики
- Индексы на статусы для фильтрации активных записей
- Составные индексы для сложных запросов

---

## 5. Подписочная система

### 5.1 Модель токенов
Система основана на токенах - внутренней валюте бота. Каждый AI-запрос стоит определенное количество токенов в зависимости от модели и сложности.

### 5.2 Тарифные планы

#### 5.2.1 Временные подписки
1. **7 дней — 150,000 токенов — 98 руб.**
2. **14 дней — 250,000 токенов — 196 руб.**
3. **21 день — 500,000 токенов — 289 руб.**
4. **30 дней — 1,000,000 токенов — 597 руб.**
5. **30 дней — 5,000,000 токенов — 2790 руб.**
6. **Безлимит на 1 день** - без ограничений по токенам

#### 5.2.2 Вечные токены (без срока действия)
1. **150,000 токенов — 149 руб.**
2. **250,000 токенов — 279 руб.**
3. **500,000 токенов — 519 руб.**
4. **1,000,000 токенов — 999 руб.**

### 5.3 Стоимость моделей в токенах

#### 5.3.1 Текстовые модели
- ChatGPT 4 Omni: 1000 токенов за запрос
- ChatGPT 4 Omni Mini: 250 токенов за запрос
- DeepSeek V2: 800 токенов за запрос
- Gemini Pro: 900 токенов за запрос
- Claude 3 Sonnet: 1200 токенов за запрос

#### 5.3.2 Генерация изображений
- Nano Banana: 6380 токенов за запрос
- DALL-E 3: 8000 токенов за запрос
- Midjourney: 12000 токенов за запрос
- Stable Diffusion: 5000 токенов за запрос
- Recraft: 7000 токенов за запрос

#### 5.3.3 Генерация видео
- Sora 2: 50000 токенов за запрос
- Veo 3.1: 45000 токенов за запрос
- Midjourney Video: 55000 токенов за запрос
- Hailuo: 40000 токенов за запрос
- Luma: 42000 токенов за запрос
- Kling: 38000 токенов за запрос

#### 5.3.4 Обработка фото и аудио
- Улучшение качества: 3000 токенов
- Удаление фона: 2000 токенов
- Замена фона: 3500 токенов
- Векторизация: 4000 токенов
- Suno (музыка): 15000 токенов
- Whisper STT: 1000 токенов
- OpenAI TTS: 2000 токенов

### 5.4 Особенности подписки
- **Безлимит ChatGPT 4 Omni Mini** при нулевом балансе для подписчиков
- Токены списываются только при успешной генерации
- При ошибке AI-сервиса токены не списываются
- Возможность докупки токенов к действующей подписке
- Система промокодов для скидок и бонусов

---

## 6. Платежная система

### 6.1 Интеграция с ЮKassa
- Подключение через API с использованием shop_id и secret_key
- Создание платежей через ЮKassa API
- Обработка webhook'ов для подтверждения платежей
- Автоматическая активация подписки после успешной оплаты

### 6.2 Поддерживаемые методы оплаты
Настройка методов оплаты производится в личном кабинете ЮKassa:
- Банковские карты (Visa, MasterCard, Мир)
- Система быстрых платежей (СБП)
- Электронные кошельки (ЮMoney, Qiwi)
- Интернет-банкинг

### 6.3 Система возвратов
- Полный возврат средств при технических проблемах
- Частичный возврат при досрочной отмене подписки
- Обработка возвратов через админ-панель
- Автоматическое списание токенов при возврате

### 6.4 Безопасность платежей
- Проверка подписи webhook'ов от ЮKassa
- Логирование всех платежных операций
- Защита от дублирования платежей
- Мониторинг подозрительных транзакций

---

## 7. AI-сервисы и интеграции

### 7.1 Требуемые API интеграции

#### 7.1.1 OpenAI
- GPT-4, GPT-4 Turbo для текста
- DALL-E 3 для генерации изображений
- Whisper для распознавания речи
- TTS для синтеза речи
- Sora (когда станет доступен) для видео

#### 7.1.2 Anthropic
- Claude 3 для текстовых запросов

#### 7.1.3 Google AI
- Gemini для текста
- Veo для генерации видео

#### 7.1.4 Stability AI
- Stable Diffusion для изображений

#### 7.1.5 Специализированные сервисы
- Midjourney через неофициальный API
- Luma Labs для видео
- Suno для музыки
- Remove.bg для удаления фона
- Различные upscale сервисы

### 7.2 Система управления ключами API
- Ротация ключей при достижении лимитов
- Мониторинг использования квот
- Fallback на альтернативные сервисы
- Автоматическое отключение неработающих ключей

### 7.3 Кеширование результатов
- Кеширование на 24 часа для экономии API-вызовов
- Хеширование запросов для определения дубликатов
- Учет кешированных запросов в статистике
- Очистка старого кеша

---

## 8. Файловая система

### 8.1 Структура хранения
```
storage/
├── images/          # Сгенерированные изображения
├── videos/          # Видео файлы
├── audio/           # Аудио файлы
├── documents/       # Документы
└── temp/           # Временные файлы
```

### 8.2 Обработка файлов
- **Максимальный размер файла:** 100 MB
- **Автоматическое сжатие:** Без потери качества
- **Поддерживаемые форматы:** JPG, PNG, MP4, MP3, PDF
- **Время хранения:** 3 дня
- **Доступ к файлам:** Через защищенный URL

### 8.3 Оптимизация изображений
- Автоматический ресайз до 1920px по большей стороне
- Конвертация в JPEG с quality=85
- Прогрессивная загрузка
- Сохранение оригинала для премиум пользователей

### 8.4 Очистка файлов
- Автоматическая очистка файлов старше 3 дней
- Ежедневная проверка в 3:00 ночи
- Логирование удаленных файлов
- Уведомление администраторов о проблемах очистки

---

## 9. Реферальная программа

### 9.1 Типы рефералов

#### 9.1.1 Пользовательские рефералы
- Каждый пользователь получает уникальную реферальную ссылку
- При регистрации по ссылке реферер получает 50% токенов от покупок реферала
- Токены начисляются на тот же срок, что купил реферал
- Бессрочное начисление бонусов

#### 9.1.2 Партнерские рефералы
- Создаются только администратором
- Денежные выплаты 10% от суммы покупок
- Возможность запроса выплат через админ-панель
- Минимальная сумма выплаты: 500 рублей

### 9.2 Механика начисления
- Автоматическое начисление после подтверждения платежа
- Уведомление рефереру о начислении бонусов
- Отслеживание конверсии рефералов в подписки
- Защита от накрутки и фродовых схем

### 9.3 Статистика рефералов
- Количество приглашенных пользователей
- Конверсия в активные подписки
- Заработанные токены и деньги
- История начислений и выплат

---

## 10. Административная панель

### 10.1 Функционал админ-бота

#### 10.1.1 Управление пользователями
- Поиск пользователей по ID, username, имени
- Просмотр детальной информации о пользователе
- Блокировка и разблокировка аккаунтов
- Добавление/списание токенов вручную
- История активности пользователя

#### 10.1.2 Управление платежами
- Список всех платежей с фильтрацией
- Детальная информация о транзакциях
- Обработка возвратов
- Статистика по платежам
- Мониторинг неудачных платежей

#### 10.1.3 Статистика и аналитика
- Общая статистика пользователей и доходов
- Статистика по AI-моделям
- Анализ конверсии
- Графики активности
- Экспорт данных

#### 10.1.4 Реферальная программа
- Создание партнерских ссылок
- Управление выплатами рефереров
- Статистика реферальной программы
- Настройка процентов и условий

#### 10.1.5 Системное администрирование
- Мониторинг состояния сервисов
- Просмотр логов ошибок
- Управление промокодами
- Настройка системных параметров
- Уведомления о критических событиях

### 10.2 Права доступа
- **Супер-администратор:** Полный доступ ко всем функциям
- **Модератор:** Управление пользователями и контентом
- **Аналитик:** Только просмотр статистики
- **Финансовый администратор:** Управление платежами и выплатами

---

## 11. Мониторинг и безопасность

### 11.1 Система мониторинга

#### 11.1.1 Метрики производительности
- CPU и память сервера
- Количество активных пользователей
- Время ответа AI-сервисов
- Количество запросов в секунду
- Статус подключения к внешним API

#### 11.1.2 Бизнес-метрики
- Количество новых пользователей
- Конверсия в подписки
- Средний чек
- Чurn rate (отток пользователей)
- Доходность по каналам привлечения

#### 11.1.3 Технические алерты
- Превышение лимитов CPU/памяти (>85%)
- Высокий процент ошибок (>5%)
- Недоступность внешних сервисов
- Переполнение диска (>90%)
- Критические ошибки приложения

### 11.2 Система безопасности

#### 11.2.1 Защита от злоупотреблений
- Rate limiting: 100 запросов в час для базовых тарифов
- Автоматическая блокировка за спам
- Детекция повторяющихся запросов
- Модерация контента на запрещенные темы
- IP-based ограничения

#### 11.2.2 Защита данных
- Шифрование конфиденциальных данных
- Безопасное хранение API ключей
- Логирование всех административных действий
- Регулярные бекапы базы данных
- GDPR совместимость

#### 11.2.3 Антифрод система
- Мониторинг подозрительных платежей
- Детекция мультиаккаунтинга
- Проверка реферальных схем
- Анализ паттернов использования
- Блокировка ботов и скрипов

---

## 12. Требования к производительности

### 12.1 Масштабируемость
- **Начальная нагрузка:** 5,000 пользователей
- **Целевая нагрузка:** 50,000 пользователей
- **Пиковая нагрузка:** 500 одновременных запросов
- **Время ответа:** <3 секунды для простых запросов
- **Uptime:** 99.5% доступности

### 12.2 Системные требования
- **Процессор:** 8 cores (начальная), 32 cores (целевая)
- **Память:** 16GB RAM (начальная), 64GB RAM (целевая)  
- **Диск:** 500GB SSD (начальная), 2TB SSD (целевая)
- **Сеть:** 1Gbps канал
- **Backup:** Ежедневные бекапы с 30-дневным хранением

### 12.3 Rate Limiting
- **Бесплатные пользователи:** 5 запросов в час
- **Базовая подписка:** 100 запросов в час
- **Премиум подписка:** 500 запросов в час
- **Глобальный лимит:** 1000 запросов в час с одного IP
- **Лимит на регистрацию:** 10 новых пользователей в час с IP

---

## 13. Логирование и аналитика

### 13.1 Система логирования
- **Уровень логирования:** DEBUG для разработки, INFO для продакшена
- **Формат логов:** Структурированный JSON
- **Ротация логов:** Ежедневная с хранением 30 дней
- **Категории логов:** Общие, AI-запросы, платежи, безопасность, ошибки

### 13.2 Метрики для отслеживания
- Количество уникальных пользователей по дням/неделям/месяцам
- Распределение по тарифным планам
- Популярность AI-моделей
- Время обработки запросов по моделям
- Конверсия из регистрации в первую покупку
- Lifetime Value (LTV) пользователей
- Эффективность реферальной программы

### 13.3 Дашборды и отчеты
- Операционный дашборд в реальном времени
- Финансовые отчеты
- Отчеты по производительности AI-сервисов
- Аналитика пользовательского поведения
- Отчеты по безопасности и злоупотреблениям

---

## 14. Развертывание и DevOps

### 14.1 Контейнеризация
- **Docker** для упаковки приложения
- **Docker Compose** для локальной разработки
- Separate containers для основного бота, админ-бота, webhook сервера
- **Health checks** для мониторинга состояния контейнеров

### 14.2 CI/CD Pipeline
- **Тестирование:** Автоматические тесты при каждом commit
- **Сборка:** Автоматическая сборка Docker образов
- **Деплой:** Blue-green deployment для минимизации downtime
- **Rollback:** Возможность быстрого отката к предыдущей версии

### 14.3 Мониторинг инфраструктуры
- **Prometheus** для сбора метрик
- **Grafana** для визуализации
- **Nginx** как reverse proxy и load balancer
- **SSL сертификаты** через Let's Encrypt
- **Backup strategy** для базы данных и файлов

---

## 15. Тестирование

### 15.1 Типы тестов
- **Unit тесты:** Покрытие критической бизнес-логики >80%
- **Integration тесты:** Тестирование API интеграций
- **End-to-end тесты:** Полные пользовательские сценарии
- **Load тесты:** Тестирование производительности под нагрузкой
- **Security тесты:** Проверка на уязвимости

### 15.2 Тестовые окружения
- **Development:** Локальная разработка
- **Staging:** Полная копия продакшена для тестирования
- **Production:** Боевое окружение

### 15.3 Мокирование внешних сервисов
- Заглушки для AI API во время тестирования
- Симуляция платежных webhook'ов
- Тестовые данные для различных сценариев

---

## 16. Документация

### 16.1 Техническая документация
- API документация для всех endpoint'ов
- Схема базы данных с описанием таблиц
- Архитектурные диаграммы
- Инструкции по развертыванию
- Runbook для операционных процедур

### 16.2 Пользовательская документация  
- FAQ для пользователей
- Инструкции по использованию AI-моделей
- Политика возвратов и конфиденциальности
- Правила использования сервиса

---

## 17. Сроки и этапы разработки

### 17.1 Этап 1 (2 недели): Базовая инфраструктура
- Настройка базы данных и основных таблиц
- Базовая структура бота с основными командами
- Интеграция с простейшими AI API (OpenAI GPT)
- Базовая система авторизации и управления пользователями

### 17.2 Этап 2 (2 недели): Платежная система
- Интеграция с ЮKassa
- Система подписок и токенов
- Обработка webhook'ов платежей
- Базовая админ-панель

### 17.3 Этап 3 (3 недели): AI интеграции
- Подключение всех запланированных AI-сервисов
- Система кеширования
- Обработка файлов и медиа
- Rate limiting и защита от злоупотреблений

### 17.4 Этап 4 (1 неделя): Реферальная система
- Механика рефералов
- Партнерская программа
- Система выплат

### 17.5 Этап 5 (1 неделя): Мониторинг и финализация
- Настройка мониторинга и алертов
- Полноценная админ-панель
- Документация и тестирование
- Подготовка к запуску

**Общий срок разработки: 9 недель**

---

## 18. Бюджет и ресурсы

### 18.1 Команда разработки
- **1 Team Lead / Senior Backend Developer**
- **1 Backend Developer**  
- **1 DevOps Engineer** (частично)
- **1 QA Engineer** (частично)

### 18.2 Инфраструктурные расходы
- **Сервер:** VPS с возможностью масштабирования
- **Домен и SSL:** $50-100/год
- **Мониторинг:** $100-200/месяц
- **AI API кредиты:** $1000-5000/месяц в зависимости от нагрузки

### 18.3 Ongoing поддержка
- Мониторинг и поддержка системы
- Обновления и новые интеграции
- Масштабирование при росте аудитории
- Техническая поддержка пользователей

---

**Данное техническое задание является полным руководством для разработки Telegram-бота и должно обеспечить всю необходимую информацию для успешной реализации проекта.**