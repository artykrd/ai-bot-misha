Формат взаимодействия с API ЮKassa
Особенности
ЮKassa — универсальное решение для работы с онлайн-платежами и выплатами. API ЮKassa построено на REST-принципах, работает с реальными объектами и обладает предсказуемым поведением. С помощью этого API вы можете отправлять запросы на оплату, сохранять платежную информацию для повторных списаний, совершать возвраты, делать выплаты и многое другое.
API в качестве основного протокола использует HTTP, а значит подходит для разработки на любом языке программирования, который умеет работать с HTTP-библиотеками (cURL и другими).
API endpoint: https://api.yookassa.ru/v3/
API поддерживает POST, GET и DELETE-запросы. POST-запросы используют JSON-аргументы, GET и DELETE-запросы работают со строками запросов. API всегда возвращает ответ в формате JSON, независимо от типа запроса.
Аутентификация
Данные для аутентификации запросов необходимо передавать в заголовке запроса в параметре Authorization.
В ЮKassa есть два способа аутентификации запросов: HTTP Basic Auth (основной) и OAuth (только для тех, кто использует API для партнеров).
HTTP Basic Auth
Для аутентификации запросов необходимо использовать HTTP Basic Auth. В заголовках запросов в качестве имени пользователя необходимо передать идентификатор вашего магазина или шлюза в ЮKassa, в качестве пароля — ваш секретный ключ.
Секретный ключ отвечает за безопасность ваших данных. Храните его в защищенном месте и не публикуйте на сторонних ресурсах (например, вместе с примерами кода).
Пример запроса с аутентификацией
cURL
PHP
Python
from yookassa import Configuration

Configuration.account_id = <Идентификатор магазина>
Configuration.secret_key = <Секретный ключ>
Узнать идентификатор и выпустить секретный ключ (а также перевыпустить и удалить неактуальный) можно в личном кабинете ЮKassa. Если у вас нет доступа к личному кабинету, попросите владельца магазина добавить вас как пользователя с ролью Разработчик. Как добавить пользователя личного кабинета ЮKassa
Для тех, кто принимает платежи
Тем, кто принимает платежи, в том числе использует Сплитование платежей или Безопасную сделку, в запросах необходимо передавать идентификатор и секретный ключ магазина:
•	Идентификатор указан в разделе Настройки — Магазин (поле shopId).
•	Секретный ключ можно получить в разделе Интеграция — Ключи API. Ключ для настоящего магазина нужно сгенерировать и активировать паролем из смс, после чего скачать себе и сохранить в надежном месте. Для тестового магазина (или интернет площадки) секретный ключ выпускается автоматически и всегда доступен в личном кабинете. Подробнее о том, как выпустить, перевыпустить и удалить секретный ключ
Для тех, кто делает выплаты
Тем, кто проводит выплаты, в запросах необходимо передавать идентификатор и секретный ключ шлюза:
•	Идентификатор указан в разделе Настройки выплат (поле agentId).
•	Секретный ключ можно получить в разделе Интеграция — Ключи API. Ключ для настоящего шлюза нужно сгенерировать и активировать паролем из смс, после чего скачать себе и сохранить в надежном месте. Для тестового шлюза секретный ключ выпускается автоматически и всегда доступен в личном кабинете. Подробнее о том, как выпустить, перевыпустить и удалить секретный ключ
OAuth
Только для тех, кто использует API для партнеров
Если вы участвуете в партнерской программе ЮKassa, для аутентификации и авторизации запросов необходимо использовать OAuth 2.0.
Вам необходимо получить OAuth-токен и передавать его с каждым запросом.
Пример запроса с использованием OAuth-токена
cURL
PHP
Python
from yookassa import Configuration

Configuration.configure_auth_token('<Bearer Token>')
OAuth-токен ЮKassa дает право выполнять финансовые операции от имени пользователя. Токен должен быть доступен только вашему приложению, поэтому не публикуйте его в открытых источниках и не сохраняйте в cookie браузера.
Идемпотентность
В контексте API идемпотентность означает, что многократные запросы обрабатываются так же, как однократные. Это значит, что, получив повторный запрос с теми же параметрами, ЮKassa выдаст в ответе результат исходного запроса. Такое поведение помогает избежать нежелательного повторения транзакций. Например, если при проведении платежа возникли проблемы с сетью, и соединение прервалось, вы сможете безопасно повторить нужный запрос неограниченное количество раз.
Для обеспечения идемпотентности используется заголовок Idempotence-Key (или ключ идемпотентности). В заголовке Idempotence-Key можно передавать любое значение, уникальное для этой операции на вашей стороне. Длина не больше 64 символов. Рекомендуется использовать V4 UUID.
Пример запроса с ключом идемпотентности
cURL
PHP
Python
from yookassa import Refund
import uuid

idempotence_key = str(uuid.uuid4())
refund = Refund.create({
  "amount": {
    "value": "2.00",
    "currency": "RUB"
  },
  "payment_id": "215d8da0-000f-50be-b000-0003308c89be"
}, idempotence_key)
Если вы повторяете запрос с теми же данными и тем же ключом, API обрабатывает его как повторный. Если данные в запросе те же, а ключ идемпотентности отличается, запрос выполняется как новый.
Ключ идемпотентности нужно передавать для POST и DELETE-запросов. GET-запросы являются по умолчанию идемпотентными, так как не имеют нежелательных последствий.
ЮKassa обеспечивает идемпотентность в течение 24 часов после первого запроса, потом повторный запрос будет обработан как новый.
Обработка запросов
ЮKassa обрабатывает полученный запрос немедленно и возвращает результат обработки («успех» или «неудача»). Ответ содержит код ответа HTTP, стандартные заголовки и при необходимости тело ответа в формате JSON. Подробнее о формате ответа
Если в течение 30 секунд невозможно дать точный ответ, например из-за неполадок на стороне эквайера, ЮKassa вернет код ответа HTTP 500, а для запросов, связанных с платежами , также попытается отменить операцию.
HTTP 500 не говорит об успешности или неуспешности выполнения вашей операции. Поэтому при получении HTTP 500 вам необходимо сначала узнать результат обработки запроса и только после этого принимать любые решения, связанные с этой операцией.



Формат ответа ЮKassa
Ответ на запрос содержит код ответа (состояния) HTTP, стандартные заголовки и при необходимости тело ответа.
Тело ответа при успехе
Основная сущность API ЮKassa — это объект. Например, для проведения платежа нужен объект платежа, а для проведения выплаты — объект выплаты. Каждый запрос в API ЮKassa связан с выполнением определенного действия над объектом, например создание объекта, получение информации о нём.
При успешной обработке запроса (HTTP 200) ЮKassa возвращает в теле ответа созданный, измененный или запрошенный объект или список объектов. Формат тела ответа — JSON. Параметры тела ответа зависят от запроса.
Подробнее об обработке ответов при HTTP 200
Пример тела ответа
JSON
{
  "id": "23d93cac-000f-5000-8000-126628f15141",
  "status": "pending",
  "paid": false,
  "amount": {
    "value": "100.00",
    "currency": "RUB"
  },
  "confirmation": {
    "type": "redirect",
    "confirmation_url": "https://yoomoney.ru/api-pages/v2/payment-confirm/epl?orderId=23d93cac-000f-5000-8000-126628f15141"
  },
  "created_at": "2019-01-22T14:30:45.129Z",
  "description": "Заказ №1",
  "metadata": {},
  "recipient": {
    "account_id": "100500",
    "gateway_id": "100700"
  },
  "refundable": false,
  "test": false
}
Развернуть
Тело ответа при ошибке
Если с запросом что-то не так (код ответа HTTP, отличный от 200), то для кодов ответа HTTP 400, 401, 403, 404, 429 и 500 вернется тело ответа в формате JSON с описанием ошибки.
Параметр	Тип	Описание
type	string	Тип объекта. Фиксированное значение — error (ошибка).
Обязательный параметр
id	string	Идентификатор ошибки. Используйте его, если вам необходимо обратиться в техническую поддержку.
Обязательный параметр
code	string	Код ошибки. Возможные значения:
•	invalid_request — неправильный запрос, например ошибка в значении параметра или нарушение логики проведения операции (HTTP 400);
•	invalid_credentials — некорректные данные для аутентификации запросов (HTTP 401);
•	forbidden — не хватает прав для выполнения операции (HTTP 403);
•	not_found — запрашиваемый ресурс не найден (HTTP 404);
•	too_many_requests — превышен лимит запросов в единицу времени (HTTP 429);
•	internal_server_error — технические неполадки на стороне ЮKassa (HTTP 500).
Обязательный параметр
description	string	Описание ошибки на английском языке.
Необязательный параметр
parameter	string	Название заголовка или параметра тела ответа, из-за которого произошла ошибка.
Необязательный параметр
Пример тела ответа при ошибке
JSON
{
  "type" : "error",
  "id" : "e65a8f85-f8b7-4f4f-9fd3-bfef99aacbbb",
  "code" : "invalid_request",
  "description" : "Idempotence key is too long. Send the value in accordance with the documentation",
  "parameter" : "Idempotence-Key"
}
У ответов с другими кодами HTTP (405, 415) тело отсутствует. Для этих ответов причина возникновения ошибки указывается в заголовках (например, в заголовке Reason-Phrase).
Подробнее об ответах при ошибке — в описании кодов ответа HTTP.



Коды ответа HTTP
Коды ответа (состояния) HTTP, которые может возвращать ЮKassa.
Код ответа HTTP	Код ошибки	Описание
200	—	Запрос успешно обработан. Для POST и GET-запросов ответ содержит созданный, измененный или запрашиваемый объект в актуальном статусе. Для DELETE-запросов тело объекта пустое.
Подробнее об обработке HTTP 200

400	invalid_request	Неправильный запрос, нарушен синтаксис или логика запроса. Чаще всего этот статус выдается из-за нарушения правил взаимодействия по API.
Подробнее об обработке HTTP 400

401	invalid_credentials	Некорректные данные для аутентификации запроса (идентификатор и секретный ключ, OAuth-токен).
Подробнее об обработке HTTP 401

403	forbidden	Не хватает прав для совершения операции.
Подробнее об обработке HTTP 403

404	not_found	Запрашиваемый ресурс не найден.
Подробнее об обработке HTTP 404

405	—	Некорректный HTTP-метод запроса. Например, ошибка возникает при попытке отправить запрос на отмену платежа методом GET вместо POST.
Подробнее об обработке HTTP 405

415	—	Некорректный тип контента для POST-запроса.
Подробнее об обработке HTTP 415

429	too_many_requests	Превышен лимит запросов в единицу времени.
Подробнее об обработке HTTP 429

500	internal_server_error	Технические неполадки на стороне ЮKassa. Результат обработки запроса неизвестен.
Подробнее об обработке HTTP 500

HTTP 200
Если запрос обработан успешно, API вернет HTTP 200 и тело ответа с результатом выполнения запроса. Формат тела ответа зависит от запроса (подробнее в Справочнике API ).
Пример ответа
HTTP
HTTP/2 200
Server: nginx
Date: Thu, 21 Apr 2022 07:39:21 GMT
Content-Type: application/json;charset=UTF-8
Content-Length: 579
Signature: v1 29f31de9 1 MGUCMQCIu97XzcGGvH2C5C+4udkuX5xcS2qcgnSJqFRCZMKFSukrhBntD7dkzhTqYHErI60CMH1e48+07gTTd7YUIPZbZCwXL7d13qMR6hEJwi1CeSPLLZSvBChn3TkQzQY0dbyBRA==
Strict-Transport-Security: max-age=15768000

{
  "id" : "29f31de9-000f-5000-a000-109987b98a6a",
  "status" : "pending",
  "amount" : {
    "value" : "2.00",
    "currency" : "RUB"
  },
  "description" : "Заказ №1",
  "recipient" : {
    "account_id" : "152368",
    "gateway_id" : "459728"
  },
  "created_at" : "2022-04-21T07:39:21.471Z",
  "confirmation" : {
    "type" : "redirect",
    "confirmation_url" : "https://yoomoney.ru/checkout/payments/v2/contract?orderId=29f31de9-000f-5000-a000-109987b98a6a"
  },
  "test" : false,
  "paid" : false,
  "refundable" : false,
  "metadata" : {
    "order_id" : "37"
  }
}
Развернуть
У некоторых объектов, например у платежей, есть статус. Он отражает результат выполнения операции. Например, если платеж создан, но пользователь еще не подтвердил его, объект платежа будет в статусе pending. Если оплата перечислена на баланс вашего магазина, статус объекта платежа будет succeeded. Если по каким-то причинам не удалось провести платеж, то статус будет canceled, объект платежа будет содержать данные о причинах отмены.
Если в ответ на запрос вы получили объект в статусе pending, вам нужно дождаться, когда объект перейдет в финальный статус. Узнать об изменении статуса можно двумя способами:
•	Подписаться на входящие уведомления и дождаться уведомления. Подробнее о входящих уведомлениях
•	Повторить запрос с теми же данными и с тем же ключом идемпотентности или запросить информацию об объекте методом GET. Если статус объекта не изменится, рекомендуется повторять запрос с возрастающим разумным интервалом (например, можно использовать последовательность Фибоначчи).
Если созданный объект должен был уже перейти в другой статус (например, закончилось время, отведенное на подтверждение платежа пользователем), а объект всё еще остается в статусе pending, обратитесь в техническую поддержку.
HTTP 400
Если запрос некорректный с точки зрения синтаксиса или логики API ЮKassa, API вернет HTTP 400. В теле ответа будет указана возникшая ошибка. Описание параметров тела ответа
Пример ответа
HTTP
HTTP/2 400
Server: nginx
Date: Thu, 21 Apr 2022 07:51:44 GMT
Content-Type: application/json;charset=UTF-8
Content-Length: 238
Signature: v1 29f320d0 1 MGQCMHU++9/SylfnZ4u5PWfyGtjib5WsLId2Jy2OnsD7+evQpETko30oTuUNNXe79VaecgIwUmiabma6qGobOP8+5KfjblFdrXg91PcwbsOX/yEIsspGnZqBKS067ulHu0UUze93

{
  "type" : "error",
  "id" : "55a02ced-be5d-462d-a6fb-0ace18881671",
  "code" : "invalid_request",
  "description" : "Idempotence key is too long. Send the value in accordance with the documentation",
  "parameter" : "Idempotence-Key"
}
Примеры ситуаций, в которых может возвращаться код ответа HTTP 400:
•	отсутствуют обязательные параметры;
•	ошибка в значении параметра (не тот формат, недопустимое значение);
•	нарушена логика формирования запроса (например, нужно передать один из двух параметров, а переданы оба, или значение в одном параметре не соответствует значению в другом параметре);
•	что-то не так с ключом идемпотентности.
Причина возникновения ошибки указана в теле ответа, в параметре description. При необходимости тело ответа содержит parameter с названием параметра, из-за которого возникла ошибка.
Поправьте ошибки и повторите запрос с новым ключом идемпотентности.
Эти ошибки необходимо поправить в процессе интеграции, чтобы при проведении реальных операций все запросы были корректными и ЮKassa могла их обработать.
HTTP 401
Если в заголовке запроса отсутствует параметр Authorization или с переданными данными для аутентификации что-то не так, API вернет HTTP 401. В теле ответа будет указана возникшая ошибка. Описание параметров тела ответа
Пример ответа
HTTP
HTTP/2 401
Server: nginx
Date: Thu, 21 Apr 2022 07:49:13 GMT
Content-Type: application/json;charset=UTF-8
Content-Length: 202
WWW-Authenticate: Basic
Signature: v1 29f32039 1 MGQCME00FWXiu+F4Jdj1vddlsiZrcEwNy3XaCoXPpJF+Fpth62D/Hxru2fWBIAMKNxaT5gIwKaUvlJg/Thj5B0mIbn8+NG4+vegpzpSUjnTRcDAxwJGve9bcj+gliWBbSeWSzZd/

{
  "type" : "error",
  "id" : "c7e8fadc-c21f-4074-b1ac-d85234eeca1d",
  "code" : "invalid_credentials",
  "description" : "Authentication by given credentials failed",
  "parameter" : "Authorization"
}
Порядок действий зависит от вашего способа аутентификации запросов:
•	HTTP Basic Auth (идентификатор магазина и секретный ключ);
•	OAuth (OAuth-токен) — относится только к тем, кто использует API для партнеров.
HTTP Basic Auth
Примеры ситуаций, в которых может возвращаться код ответа HTTP 401 при использовании HTTP Basic Auth:
•	в запросе нет идентификатора или секретного ключа;
•	идентификатор и секретный ключ указаны в неправильном порядке или формате;
•	идентификатор не соответствует тому магазину, в который вы хотите провести операцию, или в идентификаторе опечатки;
•	указанный секретный ключ неактуальный или содержит опечатки.
Причина возникновения ошибки указана в теле ответа, в параметре description. Поправьте ошибки и повторите запрос. Ключ идемпотентности можно использовать тот же или сгенерировать новый.
OAuth
Только для тех, кто использует API для партнеров.
Примеры ситуаций, в которых может возвращаться код ответа HTTP 401 при использовании OAuth-авторизации:
•	вы не передали OAuth-токен;
•	в токене есть опечатки;
•	вы удалили приложение, для которого был выдан этот токен;
•	токен устарел;
•	пользователь отозвал токен.
Причина возникновения ошибки указана в теле ответа, в параметре description. Поправьте ошибки, при необходимости получите токен заново и повторите запрос. Ключ идемпотентности можно использовать тот же или сгенерировать новый.
HTTP 403
Если запрос корректный, но не хватает прав для совершения операции, API вернет HTTP 403. В теле ответа будет указана возникшая ошибка. Описание параметров тела ответа
Пример ответа
HTTP
HTTP/2 403
Server: nginx
Date: Wed, 20 Apr 2022 13:55:23 GMT
Content-Type: application/json;charset=UTF-8
Content-Length: 281
Signature: v1 29f2248b 1 MGQCMEl6TymNwpekysxE+4ZmSze5gr2MxVolp+ZAZufDN3M+9z4mCQKvCFMQISDqubqQQwIwMr4tLc+QMYA5QnFjwK/YqHC6ESnyb1M/YxcWxpH44UcVHc7Qk6GgEGT2TGMLycbe

{
  "type" : "error",
  "id" : "17a47682-8d47-4655-a414-a58bdbcd46f9",
  "code" : "forbidden",
  "description" : "You don't have the rights to send bank card details: you need a PCI DSS certificate and a permission on YooMoney's side. Contact your YooMoney manager to learn more"
}
Примеры ситуаций, когда может возвращаться эта ошибка:
•	вы пытаетесь использовать функциональность, которую нужно предварительно согласовывать с менеджером ЮKassa (например, использование автоплатежей в реальном, а не тестовом магазине);
•	для OAuth: вы пытаетесь выполнить операцию, для которой не запрашивали права, например если вы изначально выбрали недостаточно прав или сначала получили токен, а затем отредактировали настройки приложения.
Причина возникновения ошибки указана в теле ответа, в параметре description. При необходимости тело ответа содержит parameter с названием параметра, из-за которого возникла ошибка.
Поправьте ошибки и повторите запрос с новым ключом идемпотентности.
HTTP 404
Если запрос корректный, но вы запрашиваете ресурс, которого не существует, API вернет HTTP 404. В теле ответа будет указана возникшая ошибка. Описание параметров тела ответа
Пример ответа
HTTP
HTTP/2 404
Server: nginx
Date: Thu, 21 Apr 2022 08:09:24 GMT
Content-Type: application/json;charset=UTF-8
Content-Length: 254
Signature: v1 29f324f4 1 MGQCMD6EOqWtagcxQ7MkfNGOp2FJ22Gqx1dUGWNJB61lplkAHEkIBy1w7AAFiIBl+wzjJgIwL6ZO07qfziF6wHrGH29nFd1fp4m5L1pO+NXkd8HT8n9TdtPhKn8rfsePd2fLhgvG

{
  "type" : "error",
  "id" : "cadc8c9c-26bb-417d-829d-261010fac3d5",
  "code" : "not_found",
  "description" : "Incorrect payment_id. Payment doesn't exist or access denied. Specify the payment ID created in your store.",
  "parameter" : "payment_id"
}
Примеры ситуаций, когда может возвращаться эта ошибка:
•	вы запрашиваете объект, который создан в одном вашем магазине, а данные для аутентификации используете для другого вашего магазина;
•	вы запрашиваете информацию об объекте GET-методом, но в идентификаторе опечатка.
Причина возникновения ошибки указана в теле ответа, в параметре description. При необходимости тело ответа содержит parameter с названием параметра, из-за которого возникла ошибка.
Поправьте ошибки и повторите запрос с новым ключом идемпотентности.
HTTP 405
Если вы используете некорректный HTTP-метод, API вернет HTTP 405.
Пример ответа
HTTP
HTTP/2 405
Server: nginx
Date: Thu, 21 Apr 2022 08:14:15 GMT
Content-Length: 0
Allow: POST
Reason-Phrase: Request method 'GET' not supported
Signature: v1 29f32617 1 MGQCMA1qpDjDJjRnA7U+2atTebD+czDZLDE10+tD9CPBDIfNlhjJv3oNyDXuBidZRmN+JgIwB7MPYEpQIFebcpJTLMWaRYGqACgKHXCw+jXTsfqciKCvbqDcYdQ5w4XS7mftKGxT
Поправьте HTTP-метод или эндпоинт в зависимости от того, какую операцию вы собираетесь выполнить (подробнее в Справочнике API ). Повторите запрос с новым ключом идемпотентности.
HTTP 415
Если в запросе указан некорректный тип контента, API вернет HTTP 415.
Пример ответа
HTTP
HTTP/2 415
Server: nginx
Date: Tue, 12 Apr 2022 15:48:10 GMT
Content-Length: 0
Accept: application/json
Reason-Phrase: Content type 'text/html;charset=utf-8' not supported
Signature: v1 29e7b2fa 1 MGQCMDzQ4/8Z/dPinpHZ53DNekEWgbzrFLvCE5dcseoqbnJhMzUauj0zlUliKJMETcpYMAIwTWHFd49yO7AKyyeNnhUNIFcBBpu4Td875W+h8ndI7kJOutnPC3WJBkTOEvfXpApX
Если передаете тело запроса, данные должны быть в формате JSON. Повторите запрос с новым ключом идемпотентности.
HTTP 429
Если от вас будет слишком много запросов в течение короткого промежутка времени, API вернет HTTP 429. В теле ответа будет указана возникшая ошибка. Описание параметров тела ответа
Увеличьте интервалы между запросами, чтобы снизить общее количество обращений за единицу времени.
Пример ответа
HTTP
HTTP/2 429
Server: nginx
Date: Wed, 20 Apr 2022 14:04:13 GMT
Content-Type: application/json
Content-Length: 199
Signature: v1 29f2269d 1 MGUCMQCJiMvqupFLDI4PY0dLlmVK6WnqagBVCk7OFP0qScRAALdPcFXaZZsmgzf6MSgasjICMAQZGgYdZolt98rlGJfdA/m2J7DqSuzddc1NLrzZv71eLiTYBAI+PHZ6EfyNKISGKA==

{
  "type" : "error",
  "id" : "2a9ab90e-f69f-4844-980b-4e3ec4ff1c86",
  "code" : "too_many_requests",
  "description" : "Wow, so many requests! Try to use an exponential backoff of your requests."
}
HTTP 500
Если ЮKassa по каким-то причинам не может дать точный ответ на запрос, API вернет HTTP 500. В теле ответа будет указано стандартное описание ошибки без детализации причины. Описание параметров тела ответа
Пример ответа
HTTP
HTTP/2 500
Server: nginx
Date: Wed, 20 Apr 2022 14:06:10 GMT
Content-Type: application/json;charset=UTF-8
Content-Length: 150
Signature: v1 29f22712 1 MGQCMDPcoCj6+TevC0oZqw0S2qnAqq7gOvLSykARc9G1y6qn6YLsmp095OfrAP3qmSgcmgIwMT5A3a/Wnts0tDn7iVQmBZeqMPeg/brYyPIoli/d5myF9VEaP1hvsaAhJRjVPUnW

{
  "type" : "error",
  "id" : "dd6112e5-9bc8-4382-9f6d-11e9ec39c9c3",
  "code" : "internal_server_error",
  "description" : "Internal server error"
}
HTTP 500 не говорит об успешности или неуспешности выполнения операции. Например, могут быть ситуации, когда платеж успешно прошел, но ЮKassa по каким-то причинам не смогла сообщить вам результат.
Чтобы узнать окончательный результат, повторите запрос с теми же данными и с тем же ключом идемпотентности или запросите информацию об объекте методом GET. Если ЮKassa снова вернет HTTP 500, повторяйте запрос с возрастающим разумным интервалом (например, можно использовать последовательность Фибоначчи).
Если прошло более получаса, но вы всё еще получаете HTTP 500, обратитесь в техническую поддержку для выяснения окончательного результата выполнения операции.
Статья была полезна?



Общие правила обработки ответов
При обработке ответа необходимо анализировать код ответа HTTP и статус объекта (при наличии).
1.	HTTP 200 со статусом объекта succeeded, с аналогичным финальным статусом или с объектом без статуса — операция успешна.
2.	HTTP 200 со статусом объекта pending — результат выполнения операции пока неизвестен. Дожидайтесь входящего уведомления об изменении статуса. Если у этого объекта нет уведомлений, повторите запрос с теми же данными и с тем же ключом идемпотентности или запросите информацию об объекте методом GET. Если статус объекта не изменится, повторяйте запрос с возрастающим разумным интервалом (например, можно использовать последовательность Фибоначчи).
3.	HTTP 200 со статусом объекта canceled или аналогичным финальным статусом — операция неуспешна. Проанализируйте причину, из-за которой операция не прошла. При необходимости запросите у пользователя новые данные, повторите запрос с новым ключом идемпотентности и новыми данными.
4.	HTTP 200 со статусом, отличным от succeeded, canceled, pending — запрос успешно обработан. Ваши действия зависят от значения полученного статуса.
5.	HTTP 4XX — операция неуспешна. Проанализируйте причину, из-за которой операция не прошла. При необходимости повторите запрос с новым ключом идемпотентности и новыми данными.
6.	HTTP 500 — результат обработки запроса пока не известен. Повторите запрос с теми же данными и с тем же ключом идемпотентности или запросите информацию об объекте методом GET. Если статус объекта не изменится, повторяйте запрос с возрастающим разумным интервалом (например, можно использовать последовательность Фибоначчи).
7.	Подготовка
8.	Чтобы начать работать с ЮKassa, вам нужно зарегистрироваться и получить доступ к личному кабинету. Для аутентификации запросов в API вам потребуется секретный ключ и идентификатор магазина из личного кабинета. Подробнее об основах работы с API ЮKassa
9.	Вы можете провести этот платеж в тестовом магазине. При оплате всё проходит, как при настоящих платежах, но деньги никуда не переводятся. Протестировать можно только два способа оплаты: банковские карты и ЮMoney. Подробнее о тестовом режиме
10.	Если вы хотите оценить возможности API, но у вас пока нет личного кабинета в ЮKassa, зарегистрируйтесь по этой ссылке. Это самый простой способ получить тестовый магазин. Указывать данные компании и подписывать договор не нужно.
11.	Шаг 1. Создайте платеж
12.	Платеж — главная сущность API ЮKassa. Чтобы его создать, вам понадобятся сумма платежа и URL, на который пользователь вернется после оплаты. Также вам нужно передать параметр capture со значением true. Это значит, что вы получите деньги сразу после оплаты (при значении false нужная сумма заблокируется на счете пользователя, и после этого вы можете ее списать в удобное вам время).
13.	Если хотите добавить описание платежа, которое вы увидите в личном кабинете, а пользователь — при оплате, передайте его в параметре description. Описание должно быть не более 128 символов.
14.	Отправьте ЮKassa запрос и передайте в нём данные для создания платежа, данные для аутентификации (идентификатор магазина и секретный ключ) и ключ идемпотентности (подойдет любое случайное значение).
15.	Все запросы к API ЮKassa необходимо отправлять с вашего сервера. Для взаимодействия с ЮKassa вы можете использовать готовые серверные SDK.
16.	Пример запроса на создание платежа
17.	cURL
18.	PHP
19.	Python
20.	import uuid
21.	
22.	from yookassa import Configuration, Payment
23.	
24.	Configuration.account_id = <Идентификатор магазина>
25.	Configuration.secret_key = <Секретный ключ>
26.	
27.	payment = Payment.create({
28.	    "amount": {
29.	        "value": "100.00",
30.	        "currency": "RUB"
31.	    },
32.	    "confirmation": {
33.	        "type": "redirect",
34.	        "return_url": "https://www.example.com/return_url"
35.	    },
36.	    "capture": True,
37.	    "description": "Заказ №1"
38.	}, uuid.uuid4())
39.	Шаг 2. Отправьте пользователя на страницу оплаты
40.	В теле ответа от ЮKassa вы получите созданный объект платежа  в статусе pending. Для оплаты перенаправьте пользователя на confirmation_url.
41.	Redirect — это основной сценарий подтверждения платежа пользователем. В некоторых случаях подтверждение пользователем не требуется или может проходить по другому сценарию.
42.	Пример созданного объекта платежа
43.	JSON
44.	{
45.	  "id": "23d93cac-000f-5000-8000-126628f15141",
46.	  "status": "pending",
47.	  "paid": false,
48.	  "amount": {
49.	    "value": "100.00",
50.	    "currency": "RUB"
51.	  },
52.	  "confirmation": {
53.	    "type": "redirect",
54.	    "confirmation_url": "https://yoomoney.ru/api-pages/v2/payment-confirm/epl?orderId=23d93cac-000f-5000-8000-126628f15141"
55.	  },
56.	  "created_at": "2019-01-22T14:30:45.129Z",
57.	  "description": "Заказ №1",
58.	  "metadata": {},
59.	  "recipient": {
60.	    "account_id": "100500",
61.	    "gateway_id": "100700"
62.	  },
63.	  "refundable": false,
64.	  "test": false
65.	}
66.	Развернуть
67.	Если вы создаете платеж для тестового магазина, для оплаты используйте одну из тестовых карт, например 5555555555554444 (подойдет любой код CVC и дата из будущего).
68.	После успешной оплаты (и если что-то пойдет не так) ЮKassa вернет пользователя на return_url, который вы передали при создании платежа.
69.	Шаг 3. Дождитесь успешного выполнения платежа
70.	Платеж можно считать успешным, как только он перешел в статус succeeded. Если пользователь передумает платить или что-то пойдет не так, платеж перейдет в статус canceled.
71.	Чтобы узнать статус платежа, подпишитесь на уведомления от ЮKassa.
72.	Также вы можете следить за статусом, запрашивая информацию о платеже  с удобной для вас периодичностью (например, после того, как пользователь вернулся на return_url). Для этого вам понадобится идентификатор платежа (значение параметра id в созданном объекте платежа).
73.	Ура, вы приняли первый платеж!
74.	В этом примере пользователь выбирал способы оплаты и вводил данные на стороне ЮKassa. Этот сценарий называется Умный платеж. Если для ваших задач он не подходит, вы можете выбрать другой сценарий интеграции.
75.	Помните, что для приема реальных платежей нужно использовать идентификатор и секретный ключ настоящего магазина.



Процесс платежа
В процессе платежа пользователь совершает следующие действия:
1.	выбирает способ оплаты;
2.	вводит данные для оплаты выбранным способом;
3.	при необходимости подтверждает платеж (например, проходит аутентификацию по 3-D Secure или отвечает на смс).
В ЮKassa есть несколько сценариев проведения оплаты. Сценарии различаются в зависимости от того, где пользователь выбирает способ оплаты и вводит платежные данные. В некоторых случаях пользователю нужно дополнительно подтвердить, что он согласен на оплату выбранным способом. Для этого вам будет необходимо реализовать определенный сценарий подтверждения.
Каждый платеж можно проводить в две стадии. Обычно, если пользователь внес оплату, ЮKassa сразу списывает деньги и перечисляет их на ваш расчетный счет. В двухстадийных платежах вы можете регулировать, в какой момент списать деньги и завершить платеж.
Создание платежа
Платеж  — основная сущность API ЮKassa для приема платежей.
Чтобы создать платеж, вам нужно передать в запросе :
•	данные для аутентификации;
•	ключ идемпотентности (подойдет любое случайное значение);
•	сумму платежа;
•	данные для оплаты (зависят от выбранного сценария проведения платежа).
ЮKassa умеет принимать платежи в две стадии, но для простоты вы можете провести обычный платеж (параметр capture со значением true). Это значит, что сразу после оплаты платеж успешно завершится и перейдет в статус succeeded.
Также вы можете передать дополнительные данные, например номер заказа в вашей системе. ЮKassa вернет их без изменений. Данные необходимо передавать в объекте metadata в виде набора пар «ключ-значение».
Пример запроса на создание платежа
cURL
PHP
Python
from yookassa import Configuration, Payment

Configuration.account_id = <Идентификатор магазина>
Configuration.secret_key = <Секретный ключ>

payment = Payment.create({
    "amount": {
        "value": "100.00",
        "currency": "RUB"
    },
    "confirmation": {
        "type": "redirect",
        "return_url": "https://www.example.com/return_url"
    },
    "capture": True,
    "description": "Заказ №37",
    "metadata": {
      "order_id": "37"
    }
})
В ответ на запрос придет созданный объект платежа .
Пример созданного объекта платежа
JSON
{
  "id": "2419a771-000f-5000-9000-1edaf29243f2",
  "status": "pending",
  "paid": false,
  "amount": {
    "value": "100.00",
    "currency": "RUB"
  },
  "confirmation": {
    "type": "redirect",
    "confirmation_url": "https://yoomoney.ru/api-pages/v2/payment-confirm/epl?orderId=2419a771-000f-5000-9000-1edaf29243f2"
  },
  "created_at": "2019-03-12T11:10:41.802Z",
  "description": "Заказ №37",
  "metadata": {
    "order_id": "37"
  },
  "recipient": {
    "account_id": "100500",
    "gateway_id": "100700"
  },
  "refundable": false,
  "test": false
}
Развернуть
Подтверждение платежа пользователем
Для большинства способов оплаты после создания платежа вам нужно получить согласие от пользователя, что он готов заплатить. Для этого пользователю нужно дополнительно что-то сделать, например пройти 3-D Secure при оплате банковской картой, подтвердить оплату в платежном сервисе партнера или оплатить счет в интернет-банке.
Если от пользователя нужно получить подтверждение, созданный платеж  сначала перейдет в статус pending. В следующие статусы (succeeded или waiting_for_capture) платеж перейдет, только если пользователь согласится внести оплату.
Если подтверждение не требуется, платеж сразу перейдет в статус succeeded или waiting_for_capture (если вы проводите платеж в две стадии).
Если пользователь передумает платить или что-то пойдет не так (например, на счете не окажется нужной суммы), платеж отменится и перейдет в статус canceled.
Пользователь может подтвердить платеж только за определенный срок. Если он не сделает этого, ЮKassa отменит платеж, указав причину expired_on_confirmation. Подробнее о причинах отмены платежа
Сценарии подтверждения
ЮKassa поддерживает несколько сценариев подтверждения: Redirect, External, QR-код, Embedded и Mobile application.
Сценарий подтверждения Redirect: пользователю необходимо что-то сделать на странице ЮKassa или ее партнера (например, ввести данные банковской карты или пройти аутентификацию по 3-D Secure). Вам нужно перенаправить пользователя на confirmation_url, полученный в платеже . При успешной оплате (и если что-то пойдет не так) ЮKassa вернет пользователя на return_url, который вы отправите в запросе на создание платежа .
Сценарий подтверждения External: для подтверждения платежа пользователю необходимо совершить действия во внешней системе (например, ответить на смс). От вас требуется только сообщить пользователю о дальнейших шагах.
Сценарий подтверждения QR-код: для подтверждения платежа пользователю необходимо просканировать QR-код. От вас требуется сгенерировать QR-код, используя любой доступный инструмент, и отобразить его на странице оплаты.
Сценарий подтверждения Embedded: действия, необходимые для подтверждения платежа, будут зависеть от способа оплаты, который пользователь выберет в виджете ЮKassa. Подтверждение от пользователя получит ЮKassa — вам необходимо только встроить виджет к себе на страницу.
Сценарий подтверждения Mobile application: для подтверждения платежа пользователю необходимо совершить действия в мобильном приложении (например, в приложении интернет-банка). Вам нужно перенаправить пользователя на confirmation_url, полученный в платеже . При успешной оплате (и если что-то пойдет не так) ЮKassa вернет пользователя на return_url, который вы отправите в запросе на создание платежа . Подтвердить платеж по этому сценарию можно только на мобильном устройстве (из мобильного приложения или с мобильной версии сайта).
Один способ оплаты может поддерживать несколько сценариев подтверждения. Особенности подтверждения платежа при оплате разными способами описаны в разделе Способы оплаты.
Двухстадийные платежи
Если хотите использовать эту опцию, проверьте, что нужные вам способы оплаты поддерживают холдирование. Подробнее о способах оплаты и их возможностях
Вы можете проводить платежи в две стадии:
1.	Холдирование (предавторизация): пользователь вносит оплату, и деньги замораживаются — например, на его банковской карте или в электронном кошельке (зависит от способа, которым он платит).
2.	Списание: замороженные деньги списываются по вашему запросу.
Чтобы создать двухстадийный платеж, передайте в запросе на создание платежа  параметр capture со значением false.
Пример запроса на создание двухстадийного платежа
cURL
PHP
Python
from yookassa import Configuration, Payment

Configuration.account_id = <Идентификатор магазина>
Configuration.secret_key = <Секретный ключ>

payment = Payment.create({
    "amount": {
        "value": "100.00",
        "currency": "RUB"
    },
    "confirmation": {
        "type": "redirect",
        "return_url": "https://www.example.com/return_url"
    },
    "capture": False,
    "description": "Заказ №37",
    "metadata": {
      "order_id": "37"
    }
})
Холдирование
Как только деньги будут авторизованы, платеж перейдет в статус waiting_for_capture. Этот статус означает, что вам нужно принять решение: списать оплату или отменить платеж. Если вы не сделали это за определенное время, платеж перейдет в статус canceled, а деньги автоматически вернутся пользователю.
В зависимости от способа оплаты у вас есть от 2 часов до 7 дней, чтобы списать деньги. Точное время передается в параметре expires_at. Если вы ничего не сделаете с платежом за этот срок, ЮKassa отменит платеж, указав причину expired_on_capture. Подробнее о причинах отмены платежа
Списание оплаты
Когда платеж перешел в статус waiting_for_capture, вы можете подтвердить платеж — списать оплату полностью или частично.
Полное списание
Доступно для всех способов оплаты, которые поддерживают холдирование. Подробнее о способах оплаты и их возможностях
Чтобы списать всю сумму, отправьте ЮKassa запрос на подтверждение платежа  с пустым телом запроса.
Пример запроса на списание всей суммы платежа
cURL
PHP
Python
from yookassa import Payment

Payment.capture(payment_id)
Частичное списание
Доступно для этих способов оплаты: банковская карта, кошелек ЮMoney, SberPay, Mir Pay, T Pay, «Покупки в кредит» от СберБанка.
Если вы проводите автоплатежи, при сохранении способа оплаты во время платежа можно списать часть суммы для всех способов оплаты, при повторном платеже (рекурренте) — для всех, кроме кошелька ЮMoney.
Чтобы списать только часть суммы, отправьте ЮKassa запрос на подтверждение платежа  и передайте в нём в объект amount с нужной суммой. Если сумма списания меньше суммы платежа, остаток автоматически вернется пользователю.
Пример запроса на частичное списание
cURL
PHP
Python
from yookassa import Payment
import uuid

payment_id = '215d8da0-000f-50be-b000-0003308c89be'
idempotence_key = str(uuid.uuid4())
response = Payment.capture(
  payment_id,
  {
    "amount": {
      "value": "2.00",
      "currency": "RUB"
    }
  },
  idempotence_key
)
Отмена платежа
Если вы хотите отказаться от оплаты, отправьте ЮKassa запрос на отмену платежа . Платеж перейдет в статус canceled, и деньги вернутся пользователю В этом случае ЮKassa не будет удерживать комиссию за проведение платежа.
Вы можете отменить только платежи в статусе waiting_for_capture. Если платеж перешел в статус succeeded, вы можете создать возврат.
Пример запроса на отмену платежа
cURL
PHP
Python
from yookassa import Payment
import uuid

payment_id = '215d8da0-000f-50be-b000-0003308c89be'
idempotence_key = str(uuid.uuid4())
response = Payment.cancel(
  payment_id,
  idempotence_key
)
Жизненный цикл платежа
Жизненный цикл платежа зависит от настроек вашего магазина и параметров, которые вы передадите в запросе на создание платежа . Каждому этапу жизненного цикла соответствует статус платежа .
Статусы платежа
pending — платеж создан и ожидает действий от пользователя. Если вы используете стороннюю онлайн-кассу для работы по 54-ФЗ и сценарий Сначала чек, потом платеж, то платеж может находиться в статусе pending до тех пор, пока онлайн-касса не сообщит об успешной или неуспешной регистрации чека. Из статуса pending платеж может перейти в succeeded, waiting_for_capture (при двухстадийной оплате) или canceled (если что-то пошло не так).
waiting_for_capture — платеж оплачен, деньги авторизованы и ожидают списания. Из этого статуса платеж может перейти в succeeded (если вы списали оплату) или canceled (если вы отменили платеж или что-то пошло не так).
succeeded — платеж успешно завершен, деньги будут перечислены на ваш расчетный счет в соответствии с вашим договором с ЮKassa. Это финальный и неизменяемый статус.
canceled — платеж отменен. Вы увидите этот статус, если вы отменили платеж самостоятельно, истекло время на принятие платежа или платеж был отклонен ЮKassa или платежным провайдером. Это финальный и неизменяемый статус.
В зависимости от вашего процесса часть статусов может быть пропущена, но их последовательность не меняется.
Чтобы узнать статус платежа, периодически отправляйте запросы, чтобы получить информацию о платеже , или подождите, когда придет уведомление от ЮKassa.

